# [Network] VPN server 구축 및 연결하기

앞서 VPN 에 대한 개념과 원리, 접속 과정을 전체적으로 살펴봤다.
이제 실제로 VPN 서버를 구축하고, 접속하여 VPN 서버를 통해 웹페이지가 정상적으로 수신되는지 확인하자 !
1. VPN 서버 구축 및 환경설정
개인적으로 Synology Nas 를 사용하고 있으므로, 보다 손쉽게 VPN server를 구축할 수 있는 환경이였다.
NAS에 접속하여 패키지 센터에 들어가보니 VPN server를 구성할 수 있는 패키지가 있어서 설치하였다.
설치가 완료되어 VPN server 를 실행하였다. 가상 터널을 만들 프로토콜중에서 OpenVPN 프로토콜을 선택하였다.
OpenVPN 서버를 외부에서 접속 할 수 있도록 포트 포워딩을 할 예정이기 때문에 포트를 잘기억해 놔야 한다.
프로토콜은 UDP 를 사용한다( UDP는 NAT(네트워크 주소 변환) 환경에서 더 잘 작동하는 경향이 있다. 이는 VPN 연결 시 방화벽을 우회하는 데 유리함)
내보내기 구성을 클릭하여, OpenVPN 클라이언트 설정파일을 다운로드 한다.(.ovpn)
이 설정파일로 손쉽게 클라이언트 측에서 VPN 서버를 접속하기 위한 설정을 구성 할 수 있다.
내가 설정한 포트를 NAS 라우터 설정에 적용해준다. 이러면 자동으로 포트포워딩이 되는데 이 기능을 UPNP 라고 한다.
마지막으로 방화벽 설정에서 해당 포트를 차단하지 않도록 허용해준다.
2. 내 컴퓨터에서 VPN 서버에 접속하기
VPN 서버 구축당시 내려받았던 설정파일(.ovpn)을 이용하여 내 컴퓨터(클라이언트)에서 VPN 서버로 접속을 시도해보자.현재 윈도우11 OS 에서 포스팅 중 이므로, window용 OpenVPN 클라이언트를 다운로드 받는다.
https://openvpn.net/community-downloads/
Community Downloads - Open Source VPN | OpenVPN
The OpenVPN community shares the open source OpenVPN. Download the latest version of the open source VPN release OpenVPN 2.6.3 for a secure network.
openvpn.net
설치과정에서 특별한 설정이나 조건없이 설치는 마무리 된다.  이후 아래와 같은 문구가 뜬다.
앞서 NAS 서버에서 내려받은 .ovpn 파일을 복사하여 넣어주면 될 것 같은 느낌이 든다!!
다운로드 받은 .ovpn 파일을 프로그램이 원하는 경로에 넣어주었다.
이후 작업표시줄에 실행중인 OpenVPN 아이콘을 찾고, 옵션을 선택(마우스 우 클릭)하여 접속하기를 선택한다.
리눅스 자격증을 취득했지만 역시 GUI 가 마음이 편하다^^
아이디와 비밀번호 (NAS 에 접속하는) 를 입력하고 VPN server 와 연결을 시도하였다.
하지만 역시 한번에 설정이 딱 되는게 아니였다. 오류 내역이 4개 정도 되는 것 같았다. 메시지를 하나하나 분석해보자
패킷 수신 시 압축이 활성화되어 있는데, 이는 암호화를 푸는 데 사용된 적이 있다는 오류
->  allow-compression 옵션을 체크하여 압축을 허용하거나 압축을 비활성화하는 것으로 해결할 수 있다.
--cipher가 지정되어 있지만 --data-ciphers에 누락되어 있다. (OpenVPN은 암호 설정에서 이를 무시한다)
-> data-ciphers에 AES-256-CBC를 추가하거나 업데이트하여 호환성을 유지하는 것으로 해결할 수 있다.
서버 인증서 검증 방법이 설정되어 있지 않다는 메시지가 나타나고 있다.
YOUR_SERVER_IP:1194의 호스트 주소를 확인할 수 없다는 오류가 발생하고 있다.
설정폴더에 붙어넣었던 설정파일을 메모장으로 열어보았다. 역시 default 셋팅이 보이는 곳들이 있었고, 내가 사용하고자 하는 서버의 주소와 옵션에 맞게 수정해서 연결해야 하는 것 이였다.
remote YOUR_SERVER_IP 주소에는 NAS로 연결할 수 있는 공인IP : 포트번호 를 입력해 주어야 한다. 나는 DDNS 와 포트포워딩 설정을 해주었기 때문에 romote DDNS port 로 변경한다.
#redirect-gateway def1 의 주석을 지워 활성화 한다
#dhcp-option DNS DNS_IP_ADDRESS 의 주석을 지워 활성화 하고 NAS 의 DNS 를 입력한다.
아래 완성된 설정 파일을 첨부한다.
위와같이 에러내용에 맞게 설정파일들을 다시 작성해주고, 다시 VPN 연결을 시도한다.
VPN 서버 접속에 성공하였다. VPN 서버에 직접 로그를 확인해보아도, 접속이 성공한 것을 알 수있다.
이제 VPN server에 연결된 상태로 브라우저를 통해 몇몇 페이지에 접속해보았다.
하지만 인터넷 접속이 제대로 이루어지지 않았다. 인터넷 접속이 제대로 이루어지지 않는 이유는 대략 5가지 정도로 추측해 볼 수 있었는데,
1. VPN 설정
2. 라우팅 문제
3. 방화벽 및 보안 소프트웨어
4. VPN 서버의 인터넷 연결
5. DNS 문제
등을 다음 포스팅을 통해 체크하여, VPN 서버를 통해 인터넷에 접속할 수 있도록 하자!
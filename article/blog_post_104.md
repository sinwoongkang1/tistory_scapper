# [Network] VPN 클라이언트 간 통신 테스트 - 1 (Synology NAS DS218j)

VPN 연결 설정을 다시 시도하기 위해, 공부했을때 되야 되는 상황들(?) 을 하나하나 체크해보기로 한다.
그 중에서, VPN 서버로부터 아이피를 할당받은 두 기기는 서로 ssh 연결이나 ping 테스트에 성공해야 되지 않을까?
라는 궁금증이 들었고, VPN 서버 연결 후 각 노트북과 데스크탑이 기기간 통신이 가능한지 시도해 봤다.
먼저 랩탑(맥북)은 외부 네트워크에서 연결을 하는 상황을 가정하기에, 핸드폰의 핫스팟 기능을 이용하여 다른 IP 주로를 통해 NAS의 VPN 서버로 접속했다. 랩탑에 할당된 공인아이피 주소는 233.38.52.35 였고, 연결이 성공하자 VPN 은 10.8.0.10 의 IP 주소를 할당해주었다.
데스크탑은 NAS와 같은 서브넷에 위치해 있다. 따라서 라우터 외부까지 나가지 않기 때문에 라우터의 주소 192.168.0.1 의 주소로 VPN 서버에 접속했고, 10.8.0.6 의 IP 주소를 할당받았다.
1. 두 기기간 연결 테스트
동일 네트워크에 속한 기기간 통신 연결 확인을 위해, 데스크탑에서 랩탑을 향해 ping 테스트를 진행해보았다.
ping 10.8.0.10
하지만 두 기기간의 네트워크 통신은 진행되지 않았다.
그 이유를 찾아보니
OpenVPN 서버의 기본 설정 중 하나인 client-to-client 통신 차단
일 수 있다는 것 을 찾았다.
즉,
같은 VPN에 접속한 클라이언트들끼리 서로 통신하지 못하도록 막아둔 상태
일 수 있다는 것이였다.
이 기본설정을 해제하고 클라이언트간 통신을 실행할 수 있게 하기위해, NAS 에 SSH 연결을 하여 OpenVPN 설정 파일을 수정해보도록 시도했다.
2. NAS 에 SSH 접속
-ssh [계정명] @ nas의 ip 주소
ssh kkace22@192.168.0.20
성공적으로 접속되면, root 권한으로 변경해준다.
sudo -i
접속 계정이 내 개인 계정에서 root 계정으로 변경되는 것을 확인할 수 있다.
이 root 권한 상태에서, OpenVPN 설정파일에 접근하여
client-to-client 통신기능
을 활성화 하면된다.
설정파일은 /usr/syno/etc/packages/VPNCenter/openvpn/ 폴더에 있다.
ls /usr/syno/etc/packages/VPNCenter/openvpn/
위의 경로에서 openvpn.conf 파일을 확인할 수 있다.
vi 편집기로 파일을 열고 client-to-client 설정을 추가한 뒤 종료하고 저장한다.
vi /usr/syno/etc/packages/VPNCenter/openvpn/openvpn.conf
OpenVPN 서버를 재시작 하고 두 기기를 다시 VPN 에 연결하였다.
이번엔 데스트탑에 10.8.0.3 IP 를, 랩탑에는 10.8.0.2 IP 를 할당해주었다.
먼저 ssh 연결된 NAS 에서 두 기기에 연결이 되었는지 확인해보았다.
ping 테스트 결과 VPN 서버와 데스크탑, VPN 서버와 랩탑은 패킷을 수신할 수 있는 상태였다.
하지만 데스크탑 -> NAS 의 연결과 데스크탑 -> 랩탑 의 연결을 되지 않은 상태이고 랩탑에서도 역시
랩탑 -> NAS, 랩탑 -> 데스크탑의 연결은 되지 않았다.
공부하여 찾아본 결과 이러한 문제가 생기는 원인은 크게 두가지로 파악해볼 수 있다고하는데,
1. NAS 의 ip 포워딩 설정이 없는경우
2. NAS 의 방화벽 또는 iptables 가 ping 을 차단
이라고 볼 수 있다.
따라서 이러한 트러블 슈팅을 해결 ( VPN 네트워크 기기간 통신 ) 하고, VPN 을 연결하고도 인터넷에 연결될 수 있도록 차근차근 문제를 해결해 나가보도록 하자
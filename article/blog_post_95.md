# [Network] VPN 동작 흐름 분석 및 설정포인트 확인, 연결시도 -1

지난번에 Nas에 VPN 서버를 구축하고, 데스크탑에서 VPN 소프트웨어를 설치하여 VPN 서버에 접속하는데 까지 성공하였다. 하지만 서버에서 인터넷으로 혹은 인터넷에서 받은 정보를 접속 단말기(데스크탑) 까지 보내주는데 오류가 있는 것인지, 인터넷 접속이 제대로 확인되지 않았다.
이에 단말기에서 요청한 요청 패킷과 인터넷 서버에서 보내주는 응답 패킷이 VPN 서버를 통해 어떻게 오고가는지 정확히 공부해서 어느 과정에서 문제가 생긴것인지 파악하고, 문제를 해결하고자 한다!
1. VPN 동작 파악하기
1-1. VPN 클라이언트의 VPN서버 연결시도
사용자(나) 가 VPN 소프트웨어를 통해 VPN 서버에 연결을 시도한다.
이 과정에서 사용자는 NAS에 설정된 사용자 계정과 비밀번호를 이용하여 접속할 수 있다.
* 설정포인트 : NAS 의 사용자 계정 및 비밀번호
1-2. VPN 연결 설정
사용자가 정확한 계정이름과 비밀번호를 입력하고 인증을 완료하면 공인IP와 포트번호를 통해 집안의 네트워크에
접속한다. 포트포워딩 규칙에 따라 NAS의 VPN 서버로 접속하게 된다.
*설정포인트:포트포워딩,NAT 설정, 라우터VPN 설정, DNS 설정
1-3. IP 주소 부여
VPN 클라이언트(나)가 NAS의 VPN 서버에 접속 완료되면, VPN 서버는 클라이언트에게 IP 주소를 할당한다.
이 IP 주소는 NAS의 VPN 서브냇 내에서 클라이언트에게 부여된다.
*설정포인트
아래의 VPN 설정 정보에서 동적 IP 주소를 확인해보니 클라이언트는 10.8.0.0 ~ 10.8.0.255 의 IP 를 부여받을 것으로 예상된다.
1-4. IP 를 부여받은 VPN 클라이언트와 VPN 서버는  VPN 터널이 형성된다.
이 VPN 터널을 통해 클라이언트는 인터넷 요청 패킷을 보낸다. 즉 웹 브라우저를 작동하고 특정 사이트에 접속하겠다는 URL을 입력하면, 요청 패킷을 VPN 터널을 통해 VPN 서버로 보낸다.
*확인포인트 : NAS의 VPN 서버가 요청 패킷을 수신했는가?
1-5. VPN 서버에서 요청처리
VPN 서버가 클라이언트로 부터 받은 요청 패킷을 수신하고, 클라이언트 대신 라우터를 통해 외부 인터넷으로 전달한다.
이 때 NAS의 기본 게이트웨이는 라우터의 IP 주소이다.
라우터는 요청 패킷을 외부 인터넷으로 전송한다.
*확인포인트 : VPN 서버가 요청 패킷을 라우터로 잘 전달했는가?
라우터가 요청 패킷을 외부 서버로 잘 전달했는가?
1-6. 응답 패킷 수신
요청 패킷을 정상적으로 받았다면 외부서버는 응답 패킷을 라우터로 보낸다. 라우터는 이 응답패킷을 수신하고 NAS 의 VPN 서버로 전달한다.
확인포인트 : 외부 서버로부터 라우터로 응답 패킷이 도착했는가?
라우터로 부터 VPN 서버까지 응답 패킷이 제대로 도착했는가?
1-7. 클라이언트에서 응답처리
VPN 서버에서 VPN 터널을 통해 응답 패킷을 전송한다. 클라이언트(사용자)는 VPN 서버로부터 응답 패킷을 받고 웹 브라우저에 표시된 결과를 확인한다.
*확인포인트 : VPN 서버가 응답패킷을 클라이언트에게 제대로 전송했는가?
클라이언트가 응답 패킷을 제대로 수신했는가?
2. 문제 해결 하기
2-1 윈도우 방화벽 설정 추가
인바운드 규칙, 아웃바운드 규칙에 openVPN 프로그램을 추가해주어서, 방화벽이 차단하지 못하도록 설정해주었다.
2-2. 윈도우 VPN 설정을 통한 연결하기
아무래도 vpn 프로그램보다 운영체제에서 제공하는 기능으로 직접 VPN에 연결하는게 설정이 수월할 것 같아서 시도해 보았다. 서버 이름에는 공인IP 주소를 입력하고 NAS의 사용자 id와 비밀번호를 입력해주었다.
공인 IP와 포트포워딩 규칙으로 NAS의 VPN 서버에 접속한다고 생각했기 때문에 공인 IP 를 넣어주었다.
3. 연결 성공???
기본 게이트웨이가 0.0.0.0 으로 설정되고 인터넷 연결이 활성화 되었다.
모든 페이지에 접속이 가능해서 내가 접속한 IP가 공인 아이피와 다른지 확인해보았다
하지만 내가 네이버에 접속한 ip는 공인 주소와 동일했다. 이론상 VPN 으로 접속했으면 내 접속 정보가 공인 IP가 아니여야 하는게 맞다. 아마 VPN 서버에는 연결된 것 같은데, VPN 서버와 인터넷 서버와 연결은 되지 않고, 유선  연결 되어있는 인터페이스가 패킷을 요청하고 수신한 것 같다.
ppp 어댑터가 아닌 다른 인터페이스로 접속하고 기본 게이트웨이를 설정해주는 방법을 찾아서 다시 다음에 연결하도록 하자!!
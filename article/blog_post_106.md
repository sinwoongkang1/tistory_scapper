# [Network] PPTP VPN 설정 및 내부 클라이언트간 통신 (Synology NAS DS 218j)

1.  PPTP 연결을 시도하는 이유
OpenVPN 방식으로 NAS에 VPN 서버를 구축했지만, 클라이언트 간 통신이 되지 않고 로그상 TUN/TAP invalid argument 오류가 반복적으로 발생해서 보다 가볍고 설정이 쉬운
PPTP 방식으로 우회 시도
했다.
Synology NAS의 VPN Server 패키지에서는 PPTP도 지원하고, 기본적으로 빠르게 설정이 가능하다는 장점이 있다.
(공부한 VPN 개념이 실제로도 동작한다는 것을 보고 싶었다...)
2. 집안의 네트워크 구성
ipTIME 공유기
가 인터넷 게이트웨이 역할 (NAT 및 DHCP 기능을 수행 중)
R2 공유기
는 내 방에서 브리지 모드로 작동 (192.168.0.x 대역 공유)
NAS (192.168.0.20)와 데스크탑(192.168.0.27)은 유선으로 R2에 연결 (R2 는 유뮤선 공유기)
윈도우 노트북은 R2 공유기에 무선으로 연결됨 (윈도우 노트북, 맥북, 리눅스 노트북, 스마트폰 등)
→ 전체 네트워크가
192.168.0.0/24
대역으로 구성
3. NAS에 PPTP VPN 서버 설정
PPTP 항목에서 “VPN 서버 활성화” 체크
NAS 의 방화벽에서 1723 포트 활성화 하기 ( 라우팅 구성을 실시하면 uPNP 기능으로 라우터에 전달하여 자동 포트포워딩이 된다)
활성화에 체크하고 적용하는 순간 활성화가 된다.
VPN 서버에 필요한 포트를 모조리 개방했다.
라우터 구성에서 VPN server에 필요한 포트들이 할당되어 있다.
4. 내부 네트워크에서 PPTP VPN 연결 실습
4-1.  데스크톱 PPTP 연결
네트워크 환경설정에서 PPTP 연결 설정을 구성한다.
게이트웨이 주소는 NAS 의 DDNS 를 입력했다.
PPTP 를 선택하고, 게이트웨이 주소, 로그인 계정과 암호를 입력해주었다.
→ 생각보다 빠르게(?) VPN 에 연결되었고, ppp0 이라는 인터페이스로 VPN 연결에 성공하였다.
IP 는 10.0.0.3 을 할당 받았다.
4-2. 윈도우 노트북 PPTP 연결
맥북으로 PPTP 연결을 하려고 했지만, 두 가지 문제점으로 인해 윈도우 노트북으로 PPTP 연결을 시도했다.
첫 번째 문제점은 macOS Sierra(10.12) 이후로 애플은 PPTP 지원을 공식적으로 중단.
두 번째 문제점은 모바일 핫스팟은 GRE 프로토콜은 차단한다는 문제 ( PPTP 는 TCP 1723 포트와, GRE 프로토콜을 함께 사용해야 하는데, 모바일 핫스팟은 GRE 프로토콜을 차단한다고 한다.)
윈도우 - 네트워크 설정에서 VPN 설정을 열고, 서버이름(게이트웨이주소)과, 계정, 비밀번호를 입력한다.
VPN 종류는 PPTP 로 선택!!!
생성된 VPN 에 연결하기를 누르니 생각보다 빨리 VPN 에 연결되었다. 이후 ipconfig 명령어 (윈도우는 ipconfig) 를 통해 , 네트워크 인터페이스의 상태를 확인한다.
ppp 라는 이름의 네트워크 인터페이스가 VPN과 연결되었고, 10.0.0.2 의 IP 주소를 할당 받았다.
NAS 의 VPN 서버에서도 각각의 기기들의 연결목록을 확인할 수 있었다.
5. 내부 네트워크 클라이언트 간 통신 확인
ping 10.0.0.2   # 데스크탑 → 노트북
ping 10.0.0.3   # 노트북 → 데스크탑
→ 양쪽 모두
ping 성공!
즉, PPTP 터널을 통해 클라이언트 간 직접 통신이 가능한 것 확인하였다.
데스크탑 -> 노트북, 노트북 -> 데스크탑
6. 마무리 및 추가 실습 사항
현재 연결 구조는 두 클라이언트 모두 우리 집안에서 연결된 네트워크에 의해 구성된 VPN 이기 때문에, 내가 외부에서 다른 네트워크에 접속한 상태로 VPN server 에 접속해도 내부 네트워크와 통신이 가능한지 검증하고 싶다. 이에 집앞에 있는 도서관 5층에 있는 무료 와이파이에 접속하기 위해 출동하여 비밀번호를 알아내 오도록 한다.(집에서 신호 잡힘)
목표는 5층의 공공 와이파이 이다.
또 외부 네트워크에서의 접속으로 내부 네트워크 기기와의 원활한 통신이 가능하려면 IP 포워딩 및 NAT (MASQUERADE) 설정이 필요하다고 하니 직접 실습해서 외부 네트워크에서의 접속도 정상적으로 되도록 해보자!